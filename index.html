<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .board-cell {
            transition: all 0.2s ease-in-out;
        }
        .board-cell:not(.cursor-not-allowed):hover {
            background-color: #374151; /* gray-700 */
        }
        .icon {
            stroke-width: 10;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-bg {
            animation: fadeInBg 0.3s ease-out;
        }
        @keyframes fadeInBg {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-choice {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-choice:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div class="text-center p-4 md:p-8 w-full max-w-md mx-auto">
        <h1 class="text-4xl md:text-5xl font-bold text-cyan-400 mb-2">Tic-Tac-Toe</h1>
        <p id="status-text" class="text-lg text-gray-400 mb-6 h-6 transition-opacity duration-300">Loading AI Brain...</p>

        <!-- Player Choice Screen -->
        <div id="player-choice-container" class="hidden">
            <p class="text-xl text-gray-300 mb-6">Choose your side:</p>
            <div class="flex items-center justify-center gap-6">
                <button id="choose-x-btn" class="btn-choice w-32 h-32 bg-gray-800 rounded-lg flex items-center justify-center text-red-400">
                     <svg class="w-1/2" viewBox="0 0 100 100"><line x1="10" y1="10" x2="90" y2="90" stroke="currentColor" stroke-width="10" /><line x1="90" y1="10" x2="10" y2="90" stroke="currentColor" stroke-width="10" /></svg>
                </button>
                <button id="choose-o-btn" class="btn-choice w-32 h-32 bg-gray-800 rounded-lg flex items-center justify-center text-blue-400">
                    <svg class="w-1/2" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" stroke="currentColor" fill="none" stroke-width="10"/></svg>
                </button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-container" class="hidden">
            <div id="board" class="grid grid-cols-3 gap-3 md:gap-4 aspect-square mb-6">
                <!-- Cells are generated by JavaScript -->
            </div>
            <button id="change-symbol-btn" class="w-full sm:w-auto bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200 ease-in-out">
                Change Symbol
            </button>
        </div>
    </div>

    <!-- Modal for Game Over -->
    <div id="game-over-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden modal-bg">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 text-center w-full max-w-sm modal-content">
            <h2 id="modal-title" class="text-3xl font-bold mb-4">Game Over</h2>
            <p id="modal-message" class="text-gray-300 text-lg mb-8">You won!</p>
            <button id="modal-play-again-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200 ease-in-out">
                Play Again
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const statusText = document.getElementById('status-text');
            const playerChoiceContainer = document.getElementById('player-choice-container');
            const chooseXBtn = document.getElementById('choose-x-btn');
            const chooseOBtn = document.getElementById('choose-o-btn');
            const gameContainer = document.getElementById('game-container');
            const boardElement = document.getElementById('board');
            const changeSymbolBtn = document.getElementById('change-symbol-btn');
            const gameOverModal = document.getElementById('game-over-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalPlayAgainBtn = document.getElementById('modal-play-again-btn');

            // --- Game State Variables ---
            const X_SYMBOL = 1;
            const O_SYMBOL = 2;
            let humanPlayer, aiPlayer;
            let board = [0, 0, 0, 0, 0, 0, 0, 0, 0];
            let gameStates = new Set();
            let gameActive = false;
            let currentPlayer;

            // --- Initialization ---
            async function initialize() {
                try {
                    const response = await fetch('tictactoe_states.ttts');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const arrayBuffer = await response.arrayBuffer();
                    processFile(arrayBuffer);
                    statusText.textContent = 'AI Ready. Choose your symbol.';
                    playerChoiceContainer.classList.remove('hidden');
                } catch (error) {
                    statusText.textContent = 'Error: tictactoe_states.ttts not found.';
                    console.error("Could not load game states:", error);
                }
            }

            function processFile(arrayBuffer) {
                gameStates.clear();
                const view = new DataView(arrayBuffer);
                for (let i = 0; i < view.byteLength; i += 2) {
                    const stateInt = view.getUint16(i, false); // big-endian
                    gameStates.add(stateInt);
                }
            }
            
            // --- Game Flow ---
            function selectPlayer(symbol) {
                humanPlayer = symbol;
                aiPlayer = (symbol === X_SYMBOL) ? O_SYMBOL : X_SYMBOL;
                playerChoiceContainer.classList.add('hidden');
                gameContainer.classList.remove('hidden');
                startGame();
            }

            function startGame() {
                board = [0, 0, 0, 0, 0, 0, 0, 0, 0];
                currentPlayer = X_SYMBOL; // X always starts
                gameActive = true;
                gameOverModal.classList.add('hidden');
                renderBoard();

                if (humanPlayer === O_SYMBOL) {
                    statusText.textContent = "AI's turn (X)...";
                    boardElement.classList.add('pointer-events-none');
                    setTimeout(aiMove, 600);
                } else {
                    statusText.textContent = "Your turn (X)";
                    boardElement.classList.remove('pointer-events-none');
                }
            }
            
            function returnToChoice() {
                gameActive = false;
                gameContainer.classList.add('hidden');
                gameOverModal.classList.add('hidden');
                playerChoiceContainer.classList.remove('hidden');
                statusText.textContent = 'AI Ready. Choose your symbol.';
            }

            function handleCellClick(index) {
                if (!gameActive || board[index] !== 0 || currentPlayer !== humanPlayer) return;

                makeMove(index, humanPlayer);

                if (gameActive) {
                    statusText.textContent = "AI's turn...";
                    boardElement.classList.add('pointer-events-none');
                    setTimeout(aiMove, 600);
                }
            }
            
            function makeMove(index, player) {
                if (!gameActive) return;
                board[index] = player;
                currentPlayer = (player === X_SYMBOL) ? O_SYMBOL : X_SYMBOL;
                renderBoard();
                
                const winner = checkWinner(board);
                if (winner) {
                    endGame(winner);
                } else if (board.every(cell => cell !== 0)) {
                    endGame('draw');
                }
            }
            
            function endGame(result) {
                gameActive = false;
                boardElement.classList.add('pointer-events-none');
                
                setTimeout(() => {
                    if (result === 'draw') {
                        modalTitle.textContent = "It's a Draw!";
                        modalMessage.textContent = "A hard-fought battle ends in a stalemate.";
                    } else if (result === humanPlayer) {
                        modalTitle.textContent = "You Win!";
                        modalMessage.textContent = "Congratulations, you outsmarted the AI!";
                    } else {
                        modalTitle.textContent = "AI Wins!";
                        modalMessage.textContent = "Better luck next time. The machine prevails.";
                    }
                    gameOverModal.classList.remove('hidden');
                }, 500);
            }

            // --- AI Logic ---
            function aiMove() {
                const bestMove = findBestMove();
                if (bestMove !== -1) {
                    makeMove(bestMove, aiPlayer);
                }
                if (gameActive) {
                    statusText.textContent = `Your turn (${humanPlayer === X_SYMBOL ? 'X' : 'O'})`;
                    boardElement.classList.remove('pointer-events-none');
                }
            }

            function findBestMove() {
                let bestVal = -Infinity;
                let move = -1;

                for (let i = 0; i < 9; i++) {
                    if (board[i] === 0) {
                        board[i] = aiPlayer;
                        if (gameStates.has(boardToInt(board))) {
                            let moveVal = minimax(board, 0, false);
                            if (moveVal > bestVal) {
                                bestVal = moveVal;
                                move = i;
                            }
                        }
                        board[i] = 0; // backtrack
                    }
                }
                return move;
            }

            function minimax(currentBoard, depth, isMaximizing) {
                const winner = checkWinner(currentBoard);
                if (winner === aiPlayer) return 10 - depth;
                if (winner === humanPlayer) return depth - 10;
                if (currentBoard.every(cell => cell !== 0)) return 0;

                const player = isMaximizing ? aiPlayer : humanPlayer;
                let best = isMaximizing ? -Infinity : Infinity;

                for (let i = 0; i < 9; i++) {
                    if (currentBoard[i] === 0) {
                        currentBoard[i] = player;
                        const score = minimax(currentBoard, depth + 1, !isMaximizing);
                        currentBoard[i] = 0; // backtrack
                        best = isMaximizing ? Math.max(best, score) : Math.min(best, score);
                    }
                }
                return best;
            }

            // --- Utility Functions ---
            function checkWinner(brd) {
                const winConditions = [
                    [0, 1, 2], [3, 4, 5], [6, 7, 8],
                    [0, 3, 6], [1, 4, 7], [2, 5, 8],
                    [0, 4, 8], [2, 4, 6]
                ];
                for (let cond of winConditions) {
                    const [a, b, c] = cond;
                    if (brd[a] && brd[a] === brd[b] && brd[a] === brd[c]) {
                        return brd[a];
                    }
                }
                return null;
            }
            
            function boardToInt(currentBoard) {
                let number = 0;
                for (let i = 0; i < 9; i++) {
                    number += currentBoard[i] * (3 ** i);
                }
                return number;
            }

            // --- UI Rendering ---
            function renderBoard() {
                boardElement.innerHTML = '';
                board.forEach((cell, index) => {
                    const cellElement = document.createElement('div');
                    cellElement.className = 'board-cell bg-gray-800 rounded-lg flex items-center justify-center cursor-pointer aspect-square';
                    
                    if (cell === 0 && gameActive && currentPlayer === humanPlayer) {
                         cellElement.addEventListener('click', () => handleCellClick(index));
                    } else {
                         cellElement.classList.add('cursor-not-allowed');
                    }
                    
                    if (cell === X_SYMBOL) {
                        cellElement.innerHTML = getSvgIcon('x');
                    } else if (cell === O_SYMBOL) {
                        cellElement.innerHTML = getSvgIcon('o');
                    }
                    boardElement.appendChild(cellElement);
                });
            }

            function getSvgIcon(type) {
                if (type === 'x') {
                    return `<svg class="w-1/2 text-red-400 icon" viewBox="0 0 100 100"><line x1="10" y1="10" x2="90" y2="90" stroke="currentColor" stroke-width="10"/><line x1="90" y1="10" x2="10" y2="90" stroke="currentColor" stroke-width="10"/></svg>`;
                }
                return `<svg class="w-1/2 text-blue-400 icon" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" stroke="currentColor" fill="none" stroke-width="10"/></svg>`;
            }

            // --- Event Listeners ---
            chooseXBtn.addEventListener('click', () => selectPlayer(X_SYMBOL));
            chooseOBtn.addEventListener('click', () => selectPlayer(O_SYMBOL));
            changeSymbolBtn.addEventListener('click', returnToChoice);
            modalPlayAgainBtn.addEventListener('click', startGame);

            // Start the application
            initialize();
        });
    </script>
</body>

</html>
